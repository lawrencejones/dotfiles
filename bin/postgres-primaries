#!/usr/bin/env bash

set -ef -o pipefail

if [[ "$1" -eq "--help" ]]; then

  echo """
  Desc:  Displays current Postgres primary for each environment
  Usage: postgres-primaries
  Examples...

      postgres-primaries # displays for GC_POSTGRES_ENDPOINTS_env

  """
  exit 0
fi

# resolve-primary <etcd>
function resolve-primary() {
  ETCDCTL_API=3 etcdctl get --endpoints "$1" get /postgres/main/master
}

for envPair in $(env | grep "GC_POSTGRES_ENDPOINTS_"); do
  envPair=$(perl -wnl -e '/GC_POSTGRES_ENDPOINTS_(.+)=(.+)$/ and print "$1 $2"' <<< "${envPair}")

  envName=$(cut -d' ' -f 1 <<< "${envPair}")
  etcdHost=$(cut -d' ' -f 2 <<< "${envPair}")

  host "${etcdHost}" >/dev/null 2>&1 || continue

  primaryAddr=$(etcdctl --endpoints "${etcdHost}:2379" get --print-value-only /postgres/main/master)
  primaryHost=$(ssh "${primaryAddr}" hostname -f)

  echo "${envName} ${primaryAddr} ${primaryHost}"
done | column -t
