#!/usr/bin/ruby

SSH_CONFIG_PATH="#{Dir.home}/.ssh/config"
HEADER = %(
# GENERATED BY #{__FILE__}
# AT #{Time.now.to_s} FROM #{SSH_CONFIG_PATH}
).chomp

template = File.read("#{SSH_CONFIG_PATH}.template")
compiled = template.gsub(/\$[^\(\$]\S+/) do |env_accessor|
  env_key = env_accessor[1..-1]  #Â $VAR -> VAR
  raise "Require #{env_accessor}" unless env_value = ENV[env_key]
  env_value
end

File.write(SSH_CONFIG_PATH, HEADER + "\n\n" + compiled)
